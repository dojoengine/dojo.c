name: release

on:
  push:
    tags:
      - "*"

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 1.85.0

jobs:
  prepare:
    name: Prepare release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

  build-wasm:
    name: Build WASM packages
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Extract tag version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Update package versions
        run: |
          cd packages/torii-wasm && npm version $VERSION --no-git-tag-version
          cd ../torii-client && npm version $VERSION --no-git-tag-version

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: wasm32-unknown-unknown
          toolchain: ${{ env.RUST_VERSION }}

      - uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: true

      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - uses: actions/setup-node@v3
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build WASM (no-modules)
        run: wasm-pack build crates/wasm --out-dir ../../pkg-no-modules --release --target no-modules

      - name: Build WASM (web)
        run: wasm-pack build crates/wasm --out-dir ../../pkg-web --release --target web

      - name: Build packages
        run: pnpm run build

      - name: Package WASM builds
        id: wasm_artifacts
        shell: bash
        run: |
          tar -czvf torii-wasm-no-modules.tar.gz pkg-no-modules/
          tar -czvf torii-wasm-web.tar.gz pkg-web/
          echo "files=torii-wasm-no-modules.tar.gz,torii-wasm-web.tar.gz" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            torii-wasm-no-modules.tar.gz
            torii-wasm-web.tar.gz

      - name: Publish torii-wasm
        working-directory: packages/torii-wasm
        run: pnpm publish --access public
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish torii-client
        working-directory: packages/torii-client
        run: pnpm publish --access public
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  build-uniffi:
    name: Build UniFFI bindings
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            target: x86_64-unknown-linux-gnu
            lib_name: libdojo_uniffi.so
          - os: macos-latest
            platform: darwin
            target: x86_64-apple-darwin
            lib_name: libdojo_uniffi.dylib
          - os: macos-latest
            platform: darwin
            target: aarch64-apple-darwin
            lib_name: libdojo_uniffi.dylib
          - os: windows-latest
            platform: windows
            target: x86_64-pc-windows-msvc
            lib_name: dojo_uniffi.dll

    steps:
      - uses: actions/checkout@v3

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: ${{ matrix.target }}
          toolchain: ${{ env.RUST_VERSION }}

      - uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: true

      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config

      - name: Install target
        run: rustup target add ${{ matrix.target }}

      - name: Install uniffi-bindgen-cpp
        run: cargo install --git https://github.com/Larkooo/uniffi-bindgen-cpp --branch update-0.30 uniffi-bindgen-cpp

      - name: Build UniFFI library
        run: cargo build --release --target ${{ matrix.target }} -p dojo-uniffi

      - name: Build bindgen tools
        run: |
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-swift
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-python
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-kotlin
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-cpp

      - name: Generate Swift bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-swift.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-swift
          fi

      - name: Generate Python bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-python.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-python
          fi

      - name: Generate Kotlin bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-kotlin.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-kotlin
          fi

      - name: Generate C++ bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-cpp.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-cpp
          fi

      - name: Package UniFFI bindings
        shell: bash
        run: |
          mkdir -p dojo-uniffi-${{ matrix.target }}
          cp target/${{ matrix.target }}/release/${{ matrix.lib_name }} dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/swift dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/python dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/kotlin dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/cpp dojo-uniffi-${{ matrix.target }}/
          cp -r examples dojo-uniffi-${{ matrix.target }}/
          tar -czvf dojo-uniffi-${{ matrix.target }}.tar.gz dojo-uniffi-${{ matrix.target }}/

      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dojo-uniffi-${{ matrix.target }}.tar.gz

  build-and-release:
    name: ${{ matrix.job.target }} (${{ matrix.job.os }})
    needs: prepare
    runs-on: ${{ matrix.job.os }}
    strategy:
      matrix:
        job:
          - os: ubuntu-latest
            platform: linux
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - os: ubuntu-latest
            platform: linux
            target: aarch64-unknown-linux-gnu
            arch: arm64
          - os: ubuntu-latest
            platform: android
            target: aarch64-linux-android
            arch: arm64
          - os: ubuntu-latest
            platform: android
            target: armv7-linux-androideabi
            arch: armv7
          - os: ubuntu-latest
            platform: android
            target: i686-linux-android
            arch: x86
          - os: ubuntu-latest
            platform: android
            target: x86_64-linux-android
            arch: x86_64
          - os: macos-latest
            platform: darwin
            target: x86_64-apple-darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            target: aarch64-apple-darwin
            arch: arm64
          - os: windows-latest
            platform: win32
            target: x86_64-pc-windows-msvc
            arch: amd64

    steps:
      - uses: actions/checkout@v3

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: ${{ matrix.job.target }}
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: true

      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Install cross for Linux builds
      - name: Install cross
        if: runner.os == 'Linux'
        run: cargo install cross

      # Apple M1 setup
      - name: Apple M1 setup
        if: ${{ matrix.job.target == 'aarch64-apple-darwin' }}
        run: |
          echo "SDKROOT=$(xcrun -sdk macosx --show-sdk-path)" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=$(xcrun -sdk macosx --show-sdk-platform-version)" >> $GITHUB_ENV

      # Add this step to explicitly install the target
      - name: Install Target
        run: rustup target add ${{ matrix.job.target }}

      # Build step
      - name: Build binaries
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            cross build --release --target ${{ matrix.job.target }} -p c
          else
            cargo build --release --target ${{ matrix.job.target }} -p c
          fi
        shell: bash

      - name: Package
        id: artifacts
        shell: bash
        run: |
          if [[ "${{ matrix.job.os }}" == "macos-latest" ]]; then
            tar -czvf dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz crates/c/dojo.h target/${{ matrix.job.target }}/release/libc.dylib
          elif [[ "${{ matrix.job.os }}" == "windows-latest" ]]; then
            tar -czvf dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz crates/c/dojo.h target/${{ matrix.job.target }}/release/c.dll
          else
            tar -czvf dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz crates/c/dojo.h target/${{ matrix.job.target }}/release/libc.so
          fi
          echo "file_name=dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ steps.artifacts.outputs.file_name }}

