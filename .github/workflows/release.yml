name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version tag (example: v1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 1.85.0

concurrency:
  group: release-${{ github.event.inputs.version }}
  cancel-in-progress: false

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.prepare.outputs.version }}
      tag: ${{ steps.prepare.outputs.tag }}
      target_sha: ${{ steps.prepare.outputs.target_sha }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate, bump version, tag and create draft release
        id: prepare
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_VERSION: ${{ inputs.version }}
          INPUT_PRERELEASE: ${{ inputs.prerelease }}
        run: |
          set -euo pipefail

          if ! [[ "$INPUT_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version format: $INPUT_VERSION"
            echo "Expected: v1.2.3 (optionally with prerelease suffix)"
            exit 1
          fi

          VERSION="$INPUT_VERSION"
          VERSION_NUMBER="${VERSION#v}"

          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag already exists locally: $VERSION"
            exit 1
          fi

          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "Release already exists: $VERSION"
            exit 1
          fi

          awk -v ver="$VERSION_NUMBER" '
            BEGIN { in_workspace_package = 0; done = 0 }
            /^\[workspace\.package\]$/ { in_workspace_package = 1 }
            /^\[/ && $0 != "[workspace.package]" && in_workspace_package { in_workspace_package = 0 }
            in_workspace_package && /^version = "/ && !done {
              print "version = \"" ver "\""
              done = 1
              next
            }
            { print }
          ' Cargo.toml > Cargo.toml.tmp && mv Cargo.toml.tmp Cargo.toml

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet -- Cargo.toml; then
            git add Cargo.toml
            git commit -m "chore(release): bump version to $VERSION"
            git push origin HEAD:${{ github.ref_name }}
          fi

          TARGET_SHA="$(git rev-parse HEAD)"

          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

          RELEASE_ARGS=()
          if [ "$INPUT_PRERELEASE" = "true" ]; then
            RELEASE_ARGS+=(--prerelease)
          fi

          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --target "$TARGET_SHA" \
            --draft \
            "${RELEASE_ARGS[@]}"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          echo "target_sha=$TARGET_SHA" >> "$GITHUB_OUTPUT"

  build-wasm:
    name: Build WASM packages
    needs: prepare-release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: wasm32-unknown-unknown
          toolchain: ${{ env.RUST_VERSION }}

      - uses: Swatinem/rust-cache@v2

      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM (no-modules)
        run: wasm-pack build crates/wasm --out-dir ../../pkg-no-modules --release --target no-modules

      - name: Build WASM (web)
        run: wasm-pack build crates/wasm --out-dir ../../pkg-web --release --target web

      - name: Package WASM builds
        shell: bash
        run: |
          tar -czvf torii-wasm-no-modules.tar.gz pkg-no-modules/
          tar -czvf torii-wasm-web.tar.gz pkg-web/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-wasm
          path: |
            torii-wasm-no-modules.tar.gz
            torii-wasm-web.tar.gz
          if-no-files-found: error

  build-uniffi:
    name: Build UniFFI bindings (${{ matrix.target }})
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            target: x86_64-unknown-linux-gnu
            lib_name: libdojo_uniffi.so
          - os: macos-latest
            platform: darwin
            target: x86_64-apple-darwin
            lib_name: libdojo_uniffi.dylib
          - os: macos-latest
            platform: darwin
            target: aarch64-apple-darwin
            lib_name: libdojo_uniffi.dylib
          - os: windows-latest
            platform: windows
            target: x86_64-pc-windows-msvc
            lib_name: dojo_uniffi.dll

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: ${{ matrix.target }}
          toolchain: ${{ env.RUST_VERSION }}

      - uses: Swatinem/rust-cache@v2

      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config

      - name: Install target
        run: rustup target add ${{ matrix.target }}

      - name: Install uniffi-bindgen-cpp
        run: cargo install --git https://github.com/Larkooo/uniffi-bindgen-cpp --branch update-0.30 uniffi-bindgen-cpp

      - name: Build UniFFI library
        run: cargo build --release --target ${{ matrix.target }} -p dojo-uniffi

      - name: Build bindgen tools
        run: |
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-swift
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-python
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-kotlin
          cargo build --release --target ${{ matrix.target }} --bin uniffi-bindgen-cpp

      - name: Generate Swift bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-swift.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-swift
          fi

      - name: Generate Python bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-python.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-python
          fi

      - name: Generate Kotlin bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-kotlin.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-kotlin
          fi

      - name: Generate C++ bindings
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/${{ matrix.target }}/release/uniffi-bindgen-cpp.exe
          else
            ./target/${{ matrix.target }}/release/uniffi-bindgen-cpp
          fi

      - name: Package UniFFI bindings
        shell: bash
        run: |
          mkdir -p dojo-uniffi-${{ matrix.target }}
          cp target/${{ matrix.target }}/release/${{ matrix.lib_name }} dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/swift dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/python dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/kotlin dojo-uniffi-${{ matrix.target }}/
          cp -r bindings/cpp dojo-uniffi-${{ matrix.target }}/
          cp -r examples dojo-uniffi-${{ matrix.target }}/
          tar -czvf dojo-uniffi-${{ matrix.target }}.tar.gz dojo-uniffi-${{ matrix.target }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-uniffi-${{ matrix.target }}
          path: dojo-uniffi-${{ matrix.target }}.tar.gz
          if-no-files-found: error

  build-c:
    name: Build C bindings (${{ matrix.job.target }})
    needs: prepare-release
    runs-on: ${{ matrix.job.os }}
    strategy:
      matrix:
        job:
          - os: ubuntu-latest
            platform: linux
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - os: ubuntu-latest
            platform: linux
            target: aarch64-unknown-linux-gnu
            arch: arm64
          - os: ubuntu-latest
            platform: android
            target: aarch64-linux-android
            arch: arm64
          - os: ubuntu-latest
            platform: android
            target: armv7-linux-androideabi
            arch: armv7
          - os: ubuntu-latest
            platform: android
            target: i686-linux-android
            arch: x86
          - os: ubuntu-latest
            platform: android
            target: x86_64-linux-android
            arch: x86_64
          - os: macos-latest
            platform: darwin
            target: x86_64-apple-darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            target: aarch64-apple-darwin
            arch: arm64
          - os: windows-latest
            platform: win32
            target: x86_64-pc-windows-msvc
            arch: amd64

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: ${{ matrix.job.target }}
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cross
        if: runner.os == 'Linux'
        run: cargo install cross

      - name: Apple M1 setup
        if: ${{ matrix.job.target == 'aarch64-apple-darwin' }}
        run: |
          echo "SDKROOT=$(xcrun -sdk macosx --show-sdk-path)" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=$(xcrun -sdk macosx --show-sdk-platform-version)" >> $GITHUB_ENV

      - name: Install Target
        run: rustup target add ${{ matrix.job.target }}

      - name: Build binaries
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            cross build --release --target ${{ matrix.job.target }} -p c
          else
            cargo build --release --target ${{ matrix.job.target }} -p c
          fi
        shell: bash

      - name: Package artifacts
        id: artifacts
        shell: bash
        run: |
          if [[ "${{ matrix.job.os }}" == "macos-latest" ]]; then
            tar -czvf dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz crates/c/dojo.h target/${{ matrix.job.target }}/release/libc.dylib
          elif [[ "${{ matrix.job.os }}" == "windows-latest" ]]; then
            tar -czvf dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz crates/c/dojo.h target/${{ matrix.job.target }}/release/c.dll
          else
            tar -czvf dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz crates/c/dojo.h target/${{ matrix.job.target }}/release/libc.so
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-c-${{ matrix.job.target }}-${{ matrix.job.arch }}
          path: dojo-c-${{ matrix.job.target }}-${{ matrix.job.arch }}.tar.gz
          if-no-files-found: error

  publish-release:
    name: Publish Release Assets
    runs-on: ubuntu-latest
    needs:
      - prepare-release
      - build-wasm
      - build-uniffi
      - build-c

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd release-assets
          ls -lah
          sha256sum *.tar.gz > CHECKSUMS.txt

      - name: Upload assets to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare-release.outputs.tag }}
        run: |
          set -euo pipefail
          gh release upload "$TAG" release-assets/*.tar.gz release-assets/CHECKSUMS.txt --clobber

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare-release.outputs.tag }}
        run: |
          set -euo pipefail
          gh release edit "$TAG" --draft=false --latest --title "Release $TAG"
